{% extends "base.html" %}

{% block title %}Import Stories - SKIEN{% endblock %}

{% block extra_css %}
<style>
    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .upload-area:hover {
        border-color: var(--secondary-color);
        background-color: #f8f9fa;
    }
    
    .upload-area.dragover {
        border-color: var(--secondary-color);
        background-color: #e3f2fd;
    }
    
    .step {
        display: none;
    }
    
    .step.active {
        display: block;
    }
    
    .preview-table {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .validation-error {
        color: var(--danger-color);
        font-size: 0.875em;
    }
    
    .validation-success {
        color: var(--success-color);
        font-size: 0.875em;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-upload me-2"></i>Import Stories</h2>
    <div>
        <a href="{{ url_for('admin_stories') }}" class="btn btn-outline-primary">
            <i class="fas fa-list me-2"></i>View All Stories
        </a>
    </div>
</div>

<!-- Import Steps -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-list-ol me-2"></i>Import Process
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="text-center">
                    <div class="step-indicator active" id="step1-indicator">
                        <i class="fas fa-upload fa-2x text-primary"></i>
                        <h6 class="mt-2">Upload File</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <div class="step-indicator" id="step2-indicator">
                        <i class="fas fa-cogs fa-2x text-muted"></i>
                        <h6 class="mt-2">Map Columns</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <div class="step-indicator" id="step3-indicator">
                        <i class="fas fa-eye fa-2x text-muted"></i>
                        <h6 class="mt-2">Preview Data</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <div class="step-indicator" id="step4-indicator">
                        <i class="fas fa-check fa-2x text-muted"></i>
                        <h6 class="mt-2">Import</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Step 1: Upload File -->
<div class="step active" id="step1">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-upload me-2"></i>Step 1: Upload CSV File
            </h5>
        </div>
        <div class="card-body">
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <h5>Drag & Drop your CSV file here</h5>
                    <p class="text-muted">or click to browse</p>
                    <input type="file" id="fileInput" name="file" accept=".csv" style="display: none;">
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open me-2"></i>Choose File
                    </button>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Supported formats: CSV files with columns for Title, URL, and Date
                    </small>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Step 2: Map Columns -->
<div class="step" id="step2">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-cogs me-2"></i>Step 2: Map Columns
            </h5>
        </div>
        <div class="card-body">
            <form id="mappingForm">
                <div class="row">
                    <div class="col-md-4">
                        <label for="titleColumn" class="form-label">Title Column</label>
                        <select class="form-select" id="titleColumn" name="title_column" required>
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="urlColumn" class="form-label">URL Column</label>
                        <select class="form-select" id="urlColumn" name="url_column" required>
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="dateColumn" class="form-label">Date Column</label>
                        <select class="form-select" id="dateColumn" name="date_column">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <label for="sourceColumn" class="form-label">Source Column (optional)</label>
                        <select class="form-select" id="sourceColumn" name="source_column">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="authorColumn" class="form-label">Author Column (optional)</label>
                        <select class="form-select" id="authorColumn" name="author_column">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="summaryColumn" class="form-label">Summary Column (optional)</label>
                        <select class="form-select" id="summaryColumn" name="summary_column">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4">
                    <button type="button" class="btn btn-primary" onclick="previewData()">
                        <i class="fas fa-eye me-2"></i>Preview Data
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="goToStep(1)">
                        <i class="fas fa-arrow-left me-2"></i>Back
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Step 3: Preview Data -->
<div class="step" id="step3">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-eye me-2"></i>Step 3: Preview Data
            </h5>
        </div>
        <div class="card-body">
            <div id="previewContent">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="mt-2 text-muted">Loading preview...</p>
                </div>
            </div>
            <div class="mt-4">
                <button type="button" class="btn btn-success" onclick="importData()">
                    <i class="fas fa-check me-2"></i>Import Data
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="goToStep(2)">
                    <i class="fas fa-arrow-left me-2"></i>Back
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Step 4: Import Results -->
<div class="step" id="step4">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-check me-2"></i>Step 4: Import Complete
            </h5>
        </div>
        <div class="card-body">
            <div id="importResults">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="mt-2 text-muted">Importing data...</p>
                </div>
            </div>
            <div class="mt-4">
                <button type="button" class="btn btn-primary" onclick="startOver()">
                    <i class="fas fa-redo me-2"></i>Import Another File
                </button>
                <a href="{{ url_for('admin_stories') }}" class="btn btn-outline-primary">
                    <i class="fas fa-list me-2"></i>View All Stories
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStep = 1;
let uploadedFile = null;
let columnMapping = {};
let previewData = null;

// File upload handling
document.getElementById('fileInput').addEventListener('change', handleFileSelect);
document.getElementById('uploadArea').addEventListener('click', () => document.getElementById('fileInput').click());
document.getElementById('uploadArea').addEventListener('dragover', handleDragOver);
document.getElementById('uploadArea').addEventListener('dragleave', handleDragLeave);
document.getElementById('uploadArea').addEventListener('drop', handleDrop);

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file && file.type === 'text/csv') {
        uploadedFile = file;
        processFile(file);
    } else {
        alert('Please select a valid CSV file.');
    }
}

function handleDragOver(event) {
    event.preventDefault();
    document.getElementById('uploadArea').classList.add('dragover');
}

function handleDragLeave(event) {
    event.preventDefault();
    document.getElementById('uploadArea').classList.remove('dragover');
}

function handleDrop(event) {
    event.preventDefault();
    document.getElementById('uploadArea').classList.remove('dragover');
    const file = event.dataTransfer.files[0];
    if (file && file.type === 'text/csv') {
        uploadedFile = file;
        processFile(file);
    } else {
        alert('Please drop a valid CSV file.');
    }
}

function processFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('{{ url_for("import.upload_file") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            populateColumnMapping(data.columns);
            goToStep(2);
        } else {
            alert('Error processing file: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error processing file');
    });
}

function populateColumnMapping(columns) {
    const selects = ['titleColumn', 'urlColumn', 'dateColumn', 'sourceColumn', 'authorColumn', 'summaryColumn'];
    
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Select column...</option>';
        
        columns.forEach(column => {
            const option = document.createElement('option');
            option.value = column;
            option.textContent = column;
            select.appendChild(option);
        });
    });
}

function previewData() {
    const mapping = {
        title: document.getElementById('titleColumn').value,
        url: document.getElementById('urlColumn').value,
        date: document.getElementById('dateColumn').value,
        source: document.getElementById('sourceColumn').value,
        author: document.getElementById('authorColumn').value,
        summary: document.getElementById('summaryColumn').value
    };
    
    if (!mapping.title || !mapping.url) {
        alert('Please select at least Title and URL columns.');
        return;
    }
    
    columnMapping = mapping;
    
    fetch('{{ url_for("import.preview_import") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(mapping)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayPreview(data.preview);
            goToStep(3);
        } else {
            alert('Error previewing data: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error previewing data');
    });
}

function displayPreview(data) {
    const previewContent = document.getElementById('previewContent');
    
    let html = `
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Found ${data.total_rows} rows. Showing first ${data.preview_rows.length} rows.
        </div>
        <div class="table-responsive preview-table">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>URL</th>
                        <th>Date</th>
                        <th>Source</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.preview_rows.forEach(row => {
        const statusClass = row.valid ? 'validation-success' : 'validation-error';
        const statusIcon = row.valid ? 'fa-check' : 'fa-times';
        const statusText = row.valid ? 'Valid' : row.error;
        
        html += `
            <tr>
                <td>${row.title || ''}</td>
                <td><a href="${row.url || '#'}" target="_blank">${row.url || ''}</a></td>
                <td>${row.date || ''}</td>
                <td>${row.source || ''}</td>
                <td><i class="fas ${statusIcon} me-1"></i><span class="${statusClass}">${statusText}</span></td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    previewContent.innerHTML = html;
}

function importData() {
    fetch('{{ url_for("import.process_import") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(columnMapping)
    })
    .then(response => response.json())
    .then(data => {
        displayImportResults(data);
        goToStep(4);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error importing data');
    });
}

function displayImportResults(data) {
    const resultsContent = document.getElementById('importResults');
    
    let html = `
        <div class="alert alert-${data.success ? 'success' : 'danger'}">
            <i class="fas fa-${data.success ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${data.message}
        </div>
    `;
    
    if (data.success && data.stats) {
        html += `
            <div class="row">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4 class="text-success">${data.stats.imported}</h4>
                            <p class="text-muted">Imported</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4 class="text-warning">${data.stats.duplicates}</h4>
                            <p class="text-muted">Duplicates</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4 class="text-danger">${data.stats.errors}</h4>
                            <p class="text-muted">Errors</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4 class="text-info">${data.stats.total}</h4>
                            <p class="text-muted">Total</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    resultsContent.innerHTML = html;
}

function goToStep(step) {
    // Hide all steps
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.step-indicator').forEach(s => {
        s.classList.remove('active');
        s.querySelector('i').classList.remove('text-primary');
        s.querySelector('i').classList.add('text-muted');
    });
    
    // Show current step
    document.getElementById(`step${step}`).classList.add('active');
    const indicator = document.getElementById(`step${step}-indicator`);
    if (indicator) {
        indicator.classList.add('active');
        indicator.querySelector('i').classList.remove('text-muted');
        indicator.querySelector('i').classList.add('text-primary');
    }
    
    currentStep = step;
}

function startOver() {
    currentStep = 1;
    uploadedFile = null;
    columnMapping = {};
    previewData = null;
    
    // Reset forms
    document.getElementById('uploadForm').reset();
    document.getElementById('mappingForm').reset();
    
    // Reset file input
    document.getElementById('fileInput').value = '';
    
    goToStep(1);
}
</script>
{% endblock %}